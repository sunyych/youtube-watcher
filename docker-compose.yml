services:
  postgres:
    image: postgres:15-alpine
    container_name: youtube-watcher-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-youtube_watcher}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-youtube_watcher_pass}
      POSTGRES_DB: ${POSTGRES_DB:-youtube_watcher_db}
    volumes:
      - ${POSTGRES_DATA_DIR:-./data/postgres}:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-youtube_watcher}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - youtube-watcher-network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: youtube-watcher-backend
    environment:
      WEB_PASSWORD: ${WEB_PASSWORD:-admin123}
      WEB_PORT: ${WEB_PORT:-8080}
      API_PORT: ${API_PORT:-8000}
      OLLAMA_URL: ${OLLAMA_URL:-http://host.docker.internal:11434}
      VLLM_URL: ${VLLM_URL:-}
      LLM_MODEL: ${LLM_MODEL:-qwen2.5:8b}
      ACCELERATION: ${ACCELERATION:-cpu}
      POSTGRES_USER: ${POSTGRES_USER:-youtube_watcher}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-youtube_watcher_pass}
      POSTGRES_DB: ${POSTGRES_DB:-youtube_watcher_db}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      VIDEO_STORAGE_DIR: /app/data/videos
      POSTGRES_DATA_DIR: /app/data/postgres
    volumes:
      - ${VIDEO_STORAGE_DIR:-./data/videos}:/app/data/videos
      # Mount backend code for hot reload (development mode)
      - ./backend/app:/app/app
      - ./backend/reset_password.py:/app/reset_password.py
      - ./backend/change_username.py:/app/change_username.py
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    ports:
      - "${API_PORT:-8000}:8000"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - youtube-watcher-network
    extra_hosts:
      - "host.docker.internal:host-gateway"

  queue:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: youtube-watcher-queue
    command: python -m app.queue_worker
    environment:
      OLLAMA_URL: ${OLLAMA_URL:-http://host.docker.internal:11434}
      VLLM_URL: ${VLLM_URL:-}
      LLM_MODEL: ${LLM_MODEL:-qwen2.5:8b}
      ACCELERATION: ${ACCELERATION:-cpu}
      POSTGRES_USER: ${POSTGRES_USER:-youtube_watcher}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-youtube_watcher_pass}
      POSTGRES_DB: ${POSTGRES_DB:-youtube_watcher_db}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      VIDEO_STORAGE_DIR: /app/data/videos
      POSTGRES_DATA_DIR: /app/data/postgres
    volumes:
      - ${VIDEO_STORAGE_DIR:-./data/videos}:/app/data/videos
      # Mount backend code for development
      - ./backend/app:/app/app
      - ./backend/reset_password.py:/app/reset_password.py
      - ./backend/change_username.py:/app/change_username.py
    depends_on:
      postgres:
        condition: service_healthy
      backend:
        condition: service_started
    networks:
      - youtube-watcher-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: youtube-watcher-frontend
    # volumes:
    #   # Mount frontend source for development (optional, requires rebuild for changes)
    #   # Note: Frontend needs to be rebuilt, so mounting is less useful than backend
    #   # - ./frontend/src:/app/src
    #   # - ./frontend/public:/app/public
    #   # For development, you might want to use a dev server instead
    #   # See docker-compose.dev.yml for development setup
    ports:
      - "${WEB_PORT:-8080}:80"
    depends_on:
      - backend
    networks:
      - youtube-watcher-network

networks:
  youtube-watcher-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
